<!-- index.html -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LINE CRM — LIFF</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-4xl mx-auto p-4">
    <header class="flex items-center justify-between py-4">
      <h1 class="text-2xl font-bold">LINE CRM — LIFF</h1>
      <div id="user-info" class="text-sm text-gray-600"></div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-1 bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">เพิ่มลูกค้าใหม่</h2>
        <form id="frmAdd">
          <input class="w-full p-2 border mb-2 rounded" id="name" placeholder="ชื่อลูกค้า">
          <input class="w-full p-2 border mb-2 rounded" id="phone" placeholder="เบอร์โทร">
          <input class="w-full p-2 border mb-2 rounded" id="email" placeholder="อีเมล">
          <textarea class="w-full p-2 border mb-2 rounded" id="note" placeholder="หมายเหตุ"></textarea>
          <div class="flex gap-2">
            <button class="px-4 py-2 bg-blue-600 text-white rounded" type="button" onclick="onAddCustomer()">เพิ่ม</button>
            <button class="px-4 py-2 bg-gray-200 rounded" type="button" onclick="onScanUid()">เชื่อม LINE (Login)</button>
          </div>
        </form>
      </div>

      <div class="md:col-span-2 bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-3">
          <input id="q" class="p-2 border rounded w-1/2" placeholder="ค้นหาชื่อ / เบอร์ / อีเมล">
          <div>
            <button class="px-3 py-2 bg-green-600 text-white rounded" onclick="onSearch()">ค้นหา</button>
            <button class="px-3 py-2 bg-yellow-500 text-white rounded" onclick="loadCustomers()">รีเฟรช</button>
            <button class="px-3 py-2 bg-red-500 text-white rounded" onclick="onBroadcast()">Broadcast</button>
          </div>
        </div>
        <div id="list" class="space-y-2"></div>
      </div>
    </section>
  </div>

  <script>
    let liffId = '1656079273-P30ZMXMg'; // ใส่ LIFF ID ใน Script Properties หรือแก้ที่นี่

    async function initLiff(){
      try{
        // ถ้าใส่ LIFF ID ตรงนี้ ให้ใช้งาน หรือคุณจะเรียกจาก Script Property via google.script.run
        // liffId = 'REPLACE_WITH_YOUR_LIFF_ID';
        if (!liffId) {
          // try get from server property (optional)
        }
        await liff.init({ liffId: liffId });
        if (liff.isLoggedIn()){
          const profile = await liff.getProfile();
          document.getElementById('user-info').innerText = profile.displayName;
        } else {
          document.getElementById('user-info').innerText = 'ไม่พบผู้ใช้ (กรุณาเชื่อม)';
        }
      } catch(err){ console.error(err); }
    }

    // โหลดรายการลูกค้า
    function loadCustomers(){
      document.getElementById('list').innerHTML = 'Loading...';
      google.script.run.withSuccessHandler(renderList).server_getCustomers();
    }

    function renderList(items){
      const el = document.getElementById('list'); el.innerHTML = '';
      if (!items || items.length===0) return el.innerHTML = '<div class="text-gray-500">ไม่มีข้อมูล</div>';
      items.forEach(it => {
        const d = document.createElement('div');
        d.className = 'p-3 border rounded flex justify-between items-center';
        d.innerHTML = `<div>
          <div class="font-semibold">${escapeHtml(it.name||'—')}</div>
          <div class="text-sm text-gray-600">${escapeHtml(it.phone||'—')} • ${escapeHtml(it.email||'—')}</div>
        </div>
        <div class="flex gap-2 items-center">
          <button class="px-2 py-1 bg-blue-500 text-white rounded" onclick='onOpenDetail(${JSON.stringify(it)})'>ดู</button>
          <button class="px-2 py-1 bg-indigo-600 text-white rounded" onclick='onSendMsg(${JSON.stringify(it)})'>ส่งข้อความ</button>
        </div>`;
        el.appendChild(d);
      });
    }

    function onOpenDetail(obj){
      alert('รายละเอียด:\nName: '+obj.name+'\nPhone: '+obj.phone+'\nEmail: '+obj.email+'\nNote: '+obj.note+'\nUID: '+obj.uid);
    }

    function onSendMsg(obj){
      const text = prompt('พิมพ์ข้อความที่จะส่งให้ '+(obj.name||obj.phone));
      if (!text) return;
      google.script.run.withSuccessHandler(res=>{ alert('ส่งแล้ว'); }).server_sendPush(obj.uid, text);
    }

    function onAddCustomer(){
      const customer = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        note: document.getElementById('note').value,
        uid: ''
      };
      google.script.run.withSuccessHandler(res=>{ alert('เพิ่มแล้ว'); loadCustomers(); document.getElementById('frmAdd').reset(); }).server_addCustomer(customer);
    }

    function onSearch(){
      const q = document.getElementById('q').value;
      google.script.run.withSuccessHandler(renderList).server_searchCustomers(q);
    }

    function onBroadcast(){
      const txt = prompt('ข้อความ Broadcast (ส่งถึงทุกคนที่ Follow)');
      if (!txt) return;
      google.script.run.withSuccessHandler(r=>{ alert('broadcast result:'+JSON.stringify(r)); }).server_broadcast(txt);
    }

    function onScanUid(){
      // ตัวอย่างการดึง profile แล้วบันทึก UID ลง Google Sheet
      if (!liff.isLoggedIn()){
        liff.login();
        return;
      }
      liff.getProfile().then(profile => {
        const uid = profile.userId;
        const name = profile.displayName;
        // ให้ผู้ใช้กรอกเบอร์ก่อน แล้วบันทึก uid ไปหาเรคคอร์ด
        const phone = document.getElementById('phone').value;
        if (!phone) return alert('กรุณากรอกเบอร์ลูกค้าก่อนเพื่อเชื่อม UID');
        google.script.run.withSuccessHandler(r=>{ alert('เชื่อมสำเร็จ'); }).server_saveCustomerUid(phone, uid);
      }).catch(err => console.error(err));
    }

    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    window.onload = function(){
      // ถ้าคุณต้องการใส่ LIFF ID โดยตรง ให้แก้โค้ดด้านบน
      initLiff();
      loadCustomers();
    }
  </script>
</body>
</html>
